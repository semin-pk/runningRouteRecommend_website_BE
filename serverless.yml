service: running-route-api
frameworkVersion: "3.38.0"

provider:
  name: aws
  runtime: python3.12
  region: ap-northeast-2
  memorySize: 512
  timeout: 15
  architecture: x86_64   # arm64도 가능. 이미지/네이티브 확장 없으면 arm64가 저렴.
  environment:
    # 환경변수 설정
    KAKAO_REST_API_KEY: ${env:KAKAO_REST_API_KEY}
    OPENAI_API_KEY: ${env:OPENAI_API_KEY}
    ENVIRONMENT: production
  httpApi:
    cors:
      allowedOrigins:
        - https://www.run2yourstyle.com
        - https://run2yourstyle.com
        - http://localhost:5173
        - http://localhost:3000
        - http://localhost:3001
        - http://127.0.0.1:5173
        - http://127.0.0.1:3000
        - http://127.0.0.1:3001
      allowedHeaders:
        - Content-Type
        - Authorization
        - X-Requested-With
        - Accept
        - Origin
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      allowCredentials: true


  iam:
    role:
      statements:
        # SSM SecureString 읽기 (위 environment에서 ssm 참조 시 필요)
        - Effect: Allow
          Action:
            - ssm:GetParameter
          Resource: arn:aws:ssm:${self:provider.region}:*:parameter/rrR/*
        # (SecureString일 경우 KMS 복호화가 필요할 수 있음)
        - Effect: Allow
          Action:
            - kms:Decrypt
          Resource: "*"

functions:
  api:
    handler: main.handler
    events:
      - httpApi:
          method: ANY
          path: /
      - httpApi:
          method: ANY
          path: /{proxy+}
    # 보안 설정
    #reservedConcurrency: 10  # 동시 실행 제한

package:
  # 서비스 단위 패키징. 포함/제외 패턴 지정
  patterns:
    - "**"                 # 모든 파일 포함
    - "!node_modules/**"   # node_modules 제외
    - "!.git/**"           # .git 제외
    - "!*.md"              # 마크다운 파일 제외
    - "!__pycache__/**"    # Python 캐시 제외
    - "!*.pyc"             # Python 바이트코드 제외
    - "!*.pyo"             # Python 최적화 바이트코드 제외
    - "!.pytest_cache/**"  # pytest 캐시 제외
    - "!.venv/**"          # 가상환경 제외
    - "!venv/**"           # 가상환경 제외
    - "!env/**"            # 가상환경 제외
    - "!ENV/**"            # 가상환경 제외
    - "!test.py"           # 테스트 파일 제외
    - "!tests/**"          # 테스트 디렉토리 제외
    - "!.github/**"        # GitHub Actions 제외
    - "!init_database.py"  # DB 초기화 스크립트 제외
    - "!.serverless/**"    # Serverless 빌드 아티팩트 제외
    - "!package.json"      # Node.js 패키지 파일 제외
    - "!package-lock.json" # Node.js 패키지 락 파일 제외

plugins:
  - serverless-python-requirements

resources:
  Resources:
    DeadLetterQueue:
      Type: AWS::SQS::Queue
      Properties:
        MessageRetentionPeriod: 1209600  # 14일

custom:
  pythonRequirements:
    # 핵심: Lambda와 동일한 리눅스 환경에서 빌드 (GitHub Actions 러너에 Docker 있음)
    dockerizePip: true
    # requirements.txt 경로 지정
    fileName: requirements.txt
    # 배포 크기 줄이기 (소스/휠 중 불필요한 것 제거)
    slim: true
    # Python 버전 지정(선택): 러너 기본 python이 낮을 때 유용
    pythonBin: python3
    # 불필요한 패키지 제외 (Lambda에 이미 포함되어 있음)
    noDeploy:
      - boto3
      - botocore
    # 패키지 크기 최적화를 위한 추가 옵션
    layer: false
    # pip 옵션: 불필요한 파일 제외
    pipCmdExtraArgs:
      - --no-cache-dir
