# 기능별 로직 정리 문서

이 문서는 러닝 코스 추천 서비스의 주요 기능별 로직을 상세히 정리한 것입니다.

---

## 목차

1. [빠른 검색 (경로 추천)](#1-빠른-검색-경로-추천)
2. [상세 검색 (가게 검색 및 경로 생성)](#2-상세-검색-가게-검색-및-경로-생성)
3. [가게 확정](#3-가게-확정)
4. [경로 확정](#4-경로-확정)
5. [리뷰 크롤링 및 요약](#5-리뷰-크롤링-및-요약)
6. [가게 정보 관리](#6-가게-정보-관리)

---

## 1. 빠른 검색 (경로 추천)

**엔드포인트**: `POST /api/v1/recommend`  
**서비스 함수**: `recommend_route()`  
**파일**: `app/services/recommend_service.py`

### 개요
사용자가 출발지, 목표 거리, 경유지 테마를 입력하면 자동으로 경로를 추천하는 기능입니다.

### 입력 파라미터
- `start_lat`, `start_lng`: 출발지 좌표
- `total_distance_km`: 목표 러닝 거리 (km)
- `waypoints`: 경유지 목록 (선택, 최대 10개)
  - `theme_keyword`: 검색 키워드 (예: "카페", "맛집", "맥주")
  - `order`: 경유지 순서 (1부터 시작)
- `is_round_trip`: 왕복 여부 (기본값: true)

### 로직 흐름

#### 1.1 경유지가 없는 경우

1. **목표 거리 계산**
   - 왕복: `target_distance = total_distance_km / 2`
   - 편도: `target_distance = total_distance_km`

2. **목표 지점 계산**
   - 출발지에서 랜덤 방향(0~360도)으로 `target_distance`만큼 떨어진 지점 계산
   - `calculate_destination_point()` 함수 사용 (Haversine 공식 기반)

3. **장소 검색**
   - 목표 지점 주변 1km 반경에서 "카페" 키워드로 검색
   - 목표 거리 ± 1km 오차 범위 내의 장소만 필터링
   - 필터링된 결과가 없으면:
     - 오차 범위를 2km로 확대하여 재검색
     - 여전히 없으면 목표 거리에 가장 가까운 장소 선택

4. **장소 선택**
   - 오차가 작은 상위 5개 중 랜덤 선택 (다양성 확보)

5. **경로 URL 생성**
   - 출발지 → 목적지 → (왕복인 경우) 출발지
   - 카카오맵 걷기 길찾기 URL 생성

6. **리뷰 요약 조회**
   - DB에서 해당 가게의 리뷰 요약 조회 (있으면 포함)

#### 1.2 경유지가 있는 경우

1. **구간 거리 분배**
   - 왕복: 각 구간 = `total_distance_km / (waypoint_count + 1)`
   - 편도: 각 구간 = `total_distance_km / waypoint_count`

2. **각 경유지마다 반복** (순서대로 처리)
   
   a. **목표 지점 계산**
      - 현재 위치에서 랜덤 방향으로 해당 구간 거리만큼 떨어진 지점 계산
      - 출발점으로부터의 누적 목표 거리 계산
   
   b. **장소 검색**
      - 목표 지점 주변 1km 반경에서 `theme_keyword`로 검색
      - 출발점으로부터의 목표 거리 ± 1km 오차 범위 내 필터링
      - 필터링 실패 시 오차 범위 확대하여 재검색
   
   c. **장소 선택**
      - 이미 사용된 장소 제외 (중복 방지)
      - 오차가 작은 상위 5개 중 랜덤 선택
   
   d. **위치 업데이트**
      - 선택된 장소의 좌표로 현재 위치 업데이트
      - 누적 거리 업데이트

3. **왕복 거리 계산**
   - 마지막 경유지에서 출발지까지의 거리 추가

4. **경로 URL 생성**
   - 출발지 → 경유지1 → 경유지2 → ... → (왕복인 경우) 출발지

5. **리뷰 요약 조회**
   - 각 경유지의 리뷰 요약 조회

### 핵심 함수

- `haversine_km()`: 두 좌표 간 거리 계산 (Haversine 공식)
- `calculate_destination_point()`: 출발지, 거리, 방향으로 목표 지점 계산
- `kakao_keyword_search()`: 카카오 Local API로 키워드 검색
- `find_waypoint_places()`: 목표 거리 기반 장소 검색 및 필터링
- `build_kakao_walk_url()`: 카카오맵 걷기 길찾기 URL 생성
- `get_review_summary_for_place()`: DB에서 리뷰 요약 조회

### 특징
- 목표 거리를 정확히 맞추기 위해 오차 범위 내 필터링
- 랜덤 방향으로 다양성 확보
- 중복 장소 방지
- 실패 시 점진적으로 오차 범위 확대

---

## 2. 상세 검색 (가게 검색 및 경로 생성)

**엔드포인트**: `POST /api/v1/stores/search`  
**서비스 함수**: `search_stores()`  
**파일**: `app/api/v1/store.py`

### 개요
여러 테마(경유지)로 가게를 검색하고, 사용자가 선택할 수 있도록 후보를 제공하는 기능입니다.

### 입력 파라미터
- `themes`: 검색 테마 리스트 (1~10개)
- `latitude`, `longitude`: 검색 중심 좌표
- `start_lat`, `start_lng`: 출발지 좌표 (경로 계산용)
- `total_distance_km`: 총 러닝 거리 (경로 계산용)
- `is_round_trip`: 왕복 여부
- `radius_m`: 검색 반경 (미터)

### 로직 흐름

#### 2.1 경유지가 1개인 경우 (단일 테마)

1. **목표 거리 계산**
   - 왕복: `target_distance = total_distance_km / 2`
   - 편도: `target_distance = total_distance_km`

2. **목표 지점 계산**
   - 출발지에서 랜덤 방향으로 `target_distance`만큼 떨어진 지점 계산

3. **가게 검색**
   - 목표 거리 ± 1km 오차 범위 내에서 검색
   - 상위 3개 가게 선택
   - 각 가게를 DB에 저장/업데이트 (`find_or_create_store()`)

4. **리뷰 요약 상태 확인**
   - 각 가게의 리뷰 요약 존재 여부 확인
   - 없으면 백그라운드 작업으로 크롤링 시작
   - `summary_status`: "ready" 또는 "processing"

5. **응답 반환**
   - `search_type: "single"`
   - `stores`: 가게 후보 리스트 (최대 3개)

#### 2.2 경유지가 2개 이상인 경우 (경로 생성)

1. **구간 거리 분배**
   - 빠른 검색과 동일한 방식으로 각 구간의 목표 거리 계산

2. **각 테마별 가게 검색**
   - 각 테마마다:
     - 목표 지점 계산 (현재 위치 기준)
     - 목표 거리 ± 1km 오차 범위 내에서 검색
     - 상위 5개 가게 선택 (경로 다양성 확보)
     - DB에 저장/업데이트
     - 다음 경유지를 위한 위치 업데이트

3. **경로 조합 생성**
   - 모든 테마의 가게 조합 생성 (Cartesian Product)
   - 각 조합에 대해:
     - 경로 내 중복 가게 체크
     - 총 거리 계산 (출발지 → 경유지1 → ... → 마지막 경유지)
     - 왕복인 경우 돌아오는 거리 추가
     - 목표 거리와의 오차 계산

4. **경로 정렬 및 선택**
   - 목표 거리 오차가 작은 순으로 정렬
   - 상위 경로 중에서:
     - 중복 가게 조합 제외
     - 경로 간 다양성 체크 (최소 2개 가게가 달라야 함)
     - 최대 3개 경로 선택

5. **리뷰 크롤링 시작**
   - 선택된 경로의 가게들에 대해 리뷰 요약이 없으면 백그라운드 작업 시작

6. **응답 반환**
   - `search_type: "route"`
   - `routes`: 경로 후보 리스트 (최대 3개)
   - 각 경로는 `RouteCandidate` 객체로 구성

### 핵심 함수

- `search_stores_by_theme()`: 테마로 가게 검색 (빠른 검색과 동일한 로직 사용)
- `find_or_create_store()`: 가게 정보 DB 저장/업데이트
- `check_review_summary_exists()`: 리뷰 요약 존재 여부 확인
- `process_review_summary_background()`: 백그라운드 리뷰 크롤링

### 특징
- 빠른 검색과 동일한 거리 기반 검색 로직 사용
- 경로 다양성 확보 (각 테마당 5개, 최종 3개 경로)
- 비동기 리뷰 크롤링으로 응답 속도 향상
- 경로 내 중복 가게 방지

---

## 3. 가게 확정

**엔드포인트**: `POST /api/v1/stores/confirm`  
**서비스 함수**: `confirm_store()`  
**파일**: `app/api/v1/store.py`

### 개요
상세 검색에서 선택한 단일 가게로 경로를 확정하고 추천 결과를 반환합니다.

### 입력 파라미터
- `store_id`: 선택된 가게 ID
- `start_lat`, `start_lng`: 출발지 좌표
- `total_distance_km`: 목표 러닝 거리
- `is_round_trip`: 왕복 여부

### 로직 흐름

1. **가게 정보 조회**
   - DB에서 `store_id`로 가게 정보 조회
   - 없으면 404 에러 반환

2. **거리 계산**
   - 출발지에서 가게까지의 거리 계산 (Haversine 공식)
   - 왕복인 경우 거리 × 2

3. **경로 URL 생성**
   - 출발지 → 가게 → (왕복인 경우) 출발지
   - 카카오맵 걷기 길찾기 URL 생성

4. **리뷰 요약 조회**
   - DB에서 해당 가게의 리뷰 요약 조회

5. **응답 반환**
   - `RecommendResponse` 형식으로 반환
   - `waypoints`: 선택된 가게 1개
   - `actual_total_distance_km`: 실제 총 거리

### 특징
- 단순하고 빠른 처리
- 상세 검색 결과를 그대로 활용

---

## 4. 경로 확정

**엔드포인트**: `POST /api/v1/routes/confirm`  
**서비스 함수**: `confirm_route()`  
**파일**: `app/api/v1/store.py`

### 개요
상세 검색에서 선택한 경로(여러 가게)로 확정하고 추천 결과를 반환합니다.

### 입력 파라미터
- `store_ids`: 경로에 포함된 가게 ID 리스트 (순서대로)
- `start_lat`, `start_lng`: 출발지 좌표
- `total_distance_km`: 목표 러닝 거리
- `is_round_trip`: 왕복 여부

### 로직 흐름

1. **가게 정보 조회**
   - `store_ids` 순서대로 각 가게 정보 조회
   - 하나라도 없으면 404 에러 반환

2. **구간별 거리 계산**
   - 출발지 → 첫 번째 가게
   - 첫 번째 가게 → 두 번째 가게
   - ...
   - 마지막 가게 → (왕복인 경우) 출발지
   - 각 구간의 거리를 `distance_km`로 저장

3. **경로 URL 생성**
   - 출발지 → 가게1 → 가게2 → ... → (왕복인 경우) 출발지
   - 카카오맵 걷기 길찾기 URL 생성

4. **리뷰 요약 조회**
   - 각 가게의 리뷰 요약 조회

5. **응답 반환**
   - `RecommendResponse` 형식으로 반환
   - `waypoints`: 선택된 가게들 (순서대로)
   - `actual_total_distance_km`: 실제 총 거리

### 특징
- 사용자가 선택한 경로를 그대로 반영
- 각 구간의 거리를 정확히 계산

---

## 5. 리뷰 크롤링 및 요약

**백그라운드 작업**: `process_review_summary_background()`  
**파일**: `app/services/store_service.py`, `app/utils/crawling.py`, `app/utils/llm_summarize.py`

### 개요
네이버 블로그에서 가게 리뷰를 크롤링하고, LLM으로 요약하여 DB에 저장하는 기능입니다.

### 로직 흐름

#### 5.1 검색 쿼리 생성

1. **주소 파싱**
   - 가게 주소에서 시/도, 구/군 추출 (정규표현식)
   - 예: "서울특별시 강남구" → "서울", "강남구"

2. **검색 쿼리 조합**
   - 형식: `"{시} {구} {가게이름} {테마}"`
   - 예: "서울 강남구 스타벅스 카페"
   - 시/구가 없으면 가게 이름만 사용

#### 5.2 리뷰 크롤링 (`crawling.py`)

1. **네이버 블로그 검색**
   - 검색 쿼리로 네이버 블로그 검색 URL 생성
   - Selenium으로 페이지 로드 및 스크롤

2. **블로그 포스트 링크 수집**
   - 최대 5개 포스트 링크 수집
   - 유효한 블로그 포스트만 필터링 (마이블로그, 목록 페이지 제외)

3. **포스트 내용 크롤링**
   - 각 포스트에 접속하여 본문 추출
   - 구버전/신버전 블로그 모두 지원 (iframe 처리)
   - 한글만 추출하여 정제

4. **리뷰 텍스트 합치기**
   - 최대 8개 리뷰, 각각 최대 1500자까지
   - 리뷰 간 구분자(`---`)로 연결

#### 5.3 LLM 요약 (`llm_summarize.py`)

1. **LLM 모델 초기화**
   - OpenAI GPT-4o-mini 사용
   - Temperature: 0.2 (일관성 확보)

2. **프롬프트 생성**
   - 리뷰 텍스트를 입력으로 받아 다음 정보 추출:
     - `main_menu`: 대표 메뉴 키워드 (3~4개)
     - `atmosphere`: 분위기/경험 키워드 (3~4개)
     - `recommended_for`: 추천 대상 (3~4개)

3. **JSON 파싱**
   - LLM 응답을 JSON 형식으로 파싱
   - 코드 블록 제거 후 파싱
   - 실패 시 빈 리스트 반환

#### 5.4 DB 저장

1. **리뷰 요약 저장**
   - `StoreReviewSummary` 테이블에 저장
   - 기존 요약이 있으면 업데이트, 없으면 생성
   - 크롤링 실패 시 빈 요약 저장 (재시도 방지)

2. **에러 처리**
   - 크롤링 실패, LLM 실패 모두 처리
   - 실패해도 빈 요약 저장하여 재시도 방지

### 핵심 함수

- `crawl_one_store_to_text()`: 단일 가게 크롤링 및 텍스트 반환
- `crawl_naver_blog_reviews()`: 네이버 블로그 리뷰 크롤링
- `extract_review_keywords()`: LLM으로 리뷰 키워드 추출
- `process_review_summary_background()`: 전체 프로세스 실행 (백그라운드)

### 특징
- 비동기 백그라운드 작업으로 응답 속도 향상
- 검색 쿼리 최적화 (시/구 + 가게명 + 테마)
- 실패 시 빈 요약 저장하여 무한 재시도 방지
- 독립적인 DB 세션 사용 (트랜잭션 분리)

---

## 6. 가게 정보 관리

**엔드포인트**: `POST/GET/PUT/DELETE /api/v1/stores/*`  
**파일**: `app/api/v1/store.py`, `app/services/store_service.py`

### 개요
가게 정보의 CRUD 작업을 수행하는 기능입니다.

### 주요 기능

#### 6.1 가게 생성 (`POST /api/v1/stores`)
- 새로운 가게 정보 생성
- UUID 자동 생성

#### 6.2 가게 조회 (`GET /api/v1/stores/{store_id}`)
- 단일 가게 정보 조회
- 리뷰 요약 포함 (`StoreWithReviewResponse`)

#### 6.3 가게 목록 조회 (`GET /api/v1/stores`)
- 페이징 지원 (skip, limit)
- 최대 100개까지 조회

#### 6.4 가게 업데이트 (`PUT /api/v1/stores/{store_id}`)
- 부분 업데이트 지원 (PATCH 방식)
- `exclude_unset=True`로 변경된 필드만 업데이트

#### 6.5 가게 삭제 (`DELETE /api/v1/stores/{store_id}`)
- 가게 정보 삭제
- CASCADE로 리뷰 요약도 함께 삭제

#### 6.6 가게 찾기/생성 (`find_or_create_store()`)
- Kakao API 결과로부터 가게 정보 찾기 또는 생성
- 이름, 주소, 좌표가 동일하면 기존 가게 반환
- 없으면 새로 생성
- 전화번호 등 추가 정보 업데이트

### 데이터 모델

**StoreInfo**
- `store_id`: UUID (PK)
- `name`: 가게 이름
- `address`: 상세 주소
- `longitude`, `latitude`: 좌표 (DECIMAL)
- `phone`: 전화번호
- `open_time`, `close_time`: 영업 시간

**StoreReviewSummary**
- `store_id`: FK (PK)
- `store_name`: 가게 이름 (중복 저장)
- `main_menu`: 대표 메뉴 (JSON 배열)
- `atmosphere`: 분위기 (JSON 배열)
- `recommended_for`: 추천 대상 (JSON 배열)

### 특징
- 중복 가게 방지 (이름, 주소, 좌표 기준)
- 리뷰 요약과의 1:1 관계
- JSON 필드로 유연한 데이터 저장

---

## 공통 유틸리티

### 거리 계산
- **Haversine 공식**: 지구 곡률을 고려한 실제 거리 계산
- 두 좌표 간 직선 거리 (km 단위)

### 목표 지점 계산
- 출발지, 거리, 방향(베어링)으로 목표 지점 계산
- 랜덤 방향으로 다양성 확보

### 카카오 API 통합
- **Local API**: 키워드 검색
- 카테고리 필터링 (카페: CE7, 음식점: FD6)
- 거리순 정렬
- 에러 처리 (서비스 미활성화, API 오류 등)

### 카카오맵 URL 생성
- 걷기 길찾기 URL 형식: `https://map.kakao.com/link/by/walk/{name1},{lat1},{lng1}/{name2},{lat2},{lng2}/...`

---

## 데이터 흐름 요약

```
사용자 요청
    ↓
API 엔드포인트 (Rate Limiting)
    ↓
서비스 레이어 (비즈니스 로직)
    ↓
┌─────────────────┬─────────────────┐
│  카카오 API      │  DB 조회/저장    │
│  (장소 검색)     │  (가게 정보)     │
└─────────────────┴─────────────────┘
    ↓
응답 생성 (리뷰 요약 포함)
    ↓
백그라운드 작업 (리뷰 크롤링)
    ↓
┌─────────────────┬─────────────────┐
│  네이버 크롤링  │  LLM 요약        │
│  (Selenium)     │  (OpenAI)       │
└─────────────────┴─────────────────┘
    ↓
DB 저장 (리뷰 요약)
```

---

## 주요 개선 사항

1. **거리 기반 검색**: 목표 거리를 정확히 맞추기 위한 오차 범위 필터링
2. **경로 다양성**: 랜덤 선택, 중복 방지, 경로 간 차이 확보
3. **비동기 처리**: 리뷰 크롤링을 백그라운드로 처리하여 응답 속도 향상
4. **에러 처리**: 단계별 실패 처리 및 빈 데이터 저장으로 무한 재시도 방지
5. **검색 쿼리 최적화**: 시/구 + 가게명 + 테마 조합으로 정확도 향상

---

## 참고 파일

- `app/services/recommend_service.py`: 빠른 검색 로직
- `app/services/store_service.py`: 가게 검색 및 리뷰 처리
- `app/api/v1/recommend.py`: 빠른 검색 API
- `app/api/v1/store.py`: 상세 검색 및 가게 관리 API
- `app/utils/crawling.py`: 네이버 블로그 크롤링
- `app/utils/llm_summarize.py`: LLM 리뷰 요약
- `app/models/store.py`: 데이터 모델
- `app/schemas/recommend.py`: 추천 API 스키마
- `app/schemas/store.py`: 가게 API 스키마

